<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<body>

<form th:fragment="recipeForm" th:object="${recipe}" th:action="@{/recipes}" method="post" enctype="multipart/form-data">
    <input type="hidden" th:field="*{id}" />

    <div class="mb-3">
        <label for="name" class="form-label">Recipe Name</label>
        <input type="text" id="name" class="form-control" th:field="*{name}" required>
    </div>
    <div class="mb-3">
        <label for="instructions" class="form-label">Instructions</label>
        <textarea id="instructions" class="form-control" rows="10" th:field="*{instructions}" required></textarea>
    </div>

    <div class="mb-3">
        <h5>Ingredients</h5>
        <div id="ingredients-container">
            <div th:each="ri, stat : *{recipeIngredients}" class="row mb-2 ingredient-row">
                <div class="col-md-5">
                    <input type="text" class="form-control" placeholder="Measurement (e.g., 2 cups)" th:field="*{recipeIngredients[__${stat.index}__].measurement}" required>
                </div>
                <div class="col-md-5">
                    <input type="text" class="form-control" placeholder="Ingredient Name (e.g., Flour)" th:field="*{recipeIngredients[__${stat.index}__].ingredient.name}" required>
                </div>
                <div class="col-md-2">
                    <button type="button" class="btn btn-danger" onclick="removeIngredient(this)">Remove</button>
                </div>
            </div>
        </div>
        <button type="button" class="btn btn-secondary mt-2" onclick="addIngredient()">Add Ingredient</button>
    </div>
    <div class="row mb-3">
        <div class="col-md-6">
            <label for="category-select" class="form-label">Category</label>
            <select id="category-select" class="form-select" th:field="*{category}" onchange="handleCategoryChange(this)">
                <option value="">Select a Category</option>
                <option th:each="cat : ${categories}" th:value="${cat.id}" th:text="${cat.name}"></option>
                <option value="NEW">** Add New Category **</option>
            </select>
            <input type="text" id="new-category-name" name="newCategoryName" class="form-control mt-2" placeholder="Enter new category name" style="display: none;">
        </div>
        <div class="col-md-6">
            <label for="cuisine-select" class="form-label">Cuisine</label>
            <select id="cuisine-select" class="form-select" th:field="*{cuisine}" onchange="handleCuisineChange(this)">
                <option value="">Select a Cuisine</option>
                <option th:each="cui : ${cuisines}" th:value="${cui.id}" th:text="${cui.name}"></option>
                <option value="NEW">** Add New Cuisine **</option>
            </select>
            <input type="text" id="new-cuisine-name" name="newCuisineName" class="form-control mt-2" placeholder="Enter new cuisine name" style="display: none;">
        </div>
    </div>
    <div class="mb-3">
        <label for="imageFile" class="form-label">Recipe Image</label>
        <input type="file" id="imageFile" name="imageFile" class="form-control">
        <div th:if="*{id != null and imageUrl != null}" class="mt-2">
            <small>Current Image:</small><br>
            <img th:src="*{imageUrl}" alt="Current Recipe Image" style="max-height: 100px; border-radius: 8px;">
        </div>
    </div>
    <div class="row mb-4">
        <div class="col-md-6">
            <label for="sourceUrl" class="form-label">Source URL</label>
            <input type="url" id="sourceUrl" class="form-control" th:field="*{sourceUrl}">
        </div>
        <div class="col-md-6">
            <label for="videoUrl" class="form-label">Video URL</label>
            <input type="url" id="videoUrl" class="form-control" th:field="*{videoUrl}">
        </div>
    </div>

    <button type="submit" class="btn btn-primary">Save Recipe</button>
</form>

<script th:fragment="recipeFormScript">

    function addIngredient() {
        const container = document.getElementById('ingredients-container');
        const index = container.getElementsByClassName('ingredient-row').length;
        const newIngredientRow = document.createElement('div');
        newIngredientRow.classList.add('row', 'mb-2', 'ingredient-row');
        newIngredientRow.innerHTML = `
            <div class="col-md-5">
                <input type="text" class="form-control" placeholder="Measurement" name="recipeIngredients[${index}].measurement" required>
            </div>
            <div class="col-md-5">
                <input type="text" class="form-control" placeholder="Ingredient Name" name="recipeIngredients[${index}].ingredient.name" required>
            </div>
            <div class="col-md-2">
                <button type="button" class="btn btn-danger" onclick="removeIngredient(this)">Remove</button>
            </div>
        `;
        container.appendChild(newIngredientRow);
    }

    function removeIngredient(button) {
        button.closest('.ingredient-row').remove();
        updateIngredientIndices();
    }

    function updateIngredientIndices() {
        const container = document.getElementById('ingredients-container');
        const rows = container.getElementsByClassName('ingredient-row');
        Array.from(rows).forEach((row, index) => {
            const measurementInput = row.querySelector('input[name*="measurement"]');
            const ingredientNameInput = row.querySelector('input[name*="ingredient.name"]');
            if (measurementInput) measurementInput.setAttribute('name', `recipeIngredients[${index}].measurement`);
            if (ingredientNameInput) ingredientNameInput.setAttribute('name', `recipeIngredients[${index}].ingredient.name`);
        });
    }

    function handleCategoryChange(selectElement) {
        const newCategoryInput = document.getElementById('new-category-name');
        if (selectElement.value === 'NEW') {
            newCategoryInput.style.display = 'block';
            newCategoryInput.setAttribute('required', 'true');
        } else {
            newCategoryInput.style.display = 'none';
            newCategoryInput.removeAttribute('required');
            newCategoryInput.value = '';
        }
    }

    function handleCuisineChange(selectElement) {
        const newCuisineInput = document.getElementById('new-cuisine-name');
        if (selectElement.value === 'NEW') {
            newCuisineInput.style.display = 'block';
            newCuisineInput.setAttribute('required', 'true');
        } else {
            newCuisineInput.style.display = 'none';
            newCuisineInput.removeAttribute('required');
            newCuisineInput.value = '';
        }
    }
</script>

</body>
</html>